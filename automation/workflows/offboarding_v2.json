{
  "name": "Employee Offboarding (Leaver)",
  "description": "Comprehensive automated workflow for offboarding employees with compliance hold, audit trail, and regulatory requirements",
  "version": "2.0.0",
  "trigger": {
    "type": "user_deactivation_request",
    "source": ["hris_sync", "manual", "api"],
    "filters": {
      "userType": ["employee", "contractor"]
    }
  },
  "prerequisites": {
    "approvalRequired": true,
    "approvers": ["manager", "hr_admin"],
    "validationRules": [
      {
        "field": "terminationDate",
        "rule": "future_or_today"
      }
    ]
  },
  "variables": {
    "userId": "{{event.user.id}}",
    "userEmail": "{{event.user.profile.email}}",
    "userName": "{{event.user.profile.firstName}} {{event.user.profile.lastName}}",
    "managerId": "{{event.user.profile.managerId}}",
    "managerEmail": "{{event.user.profile.managerEmail}}",
    "department": "{{event.user.profile.department}}",
    "terminationDate": "{{event.terminationDate}}",
    "terminationType": "{{event.terminationType}}",
    "complianceHoldRequired": "{{event.complianceHold}}",
    "retentionPeriod": "{{config.defaultRetentionDays}}"
  },
  "steps": [
    {
      "id": "1",
      "name": "Log Offboarding Initiated",
      "action": "audit.log",
      "parameters": {
        "eventType": "OFFBOARDING_INITIATED",
        "userId": "{{variables.userId}}",
        "severity": "INFO",
        "details": {
          "terminationDate": "{{variables.terminationDate}}",
          "terminationType": "{{variables.terminationType}}",
          "initiatedBy": "{{event.initiator}}"
        }
      }
    },
    {
      "id": "2",
      "name": "Capture Pre-Offboarding State",
      "action": "snapshot.create",
      "parameters": {
        "userId": "{{variables.userId}}",
        "captureItems": ["groups", "applications", "factors", "sessions", "devices"],
        "format": "json",
        "storageLocation": "{{config.auditStoragePath}}/{{variables.userId}}"
      },
      "outputVariable": "preOffboardingSnapshot"
    },
    {
      "id": "3",
      "name": "Revoke All Active Sessions",
      "action": "okta.sessions.clearAll",
      "parameters": {
        "userId": "{{variables.userId}}",
        "includeRefreshTokens": true
      }
    },
    {
      "id": "4",
      "name": "Revoke OAuth Tokens",
      "action": "okta.tokens.revokeAll",
      "parameters": {
        "userId": "{{variables.userId}}",
        "tokenTypes": ["access_token", "refresh_token", "id_token"]
      }
    },
    {
      "id": "5",
      "name": "Remove from All Groups",
      "action": "okta.groups.removeFromAll",
      "parameters": {
        "userId": "{{variables.userId}}",
        "excludeGroups": ["{{config.complianceHoldGroup}}"],
        "logRemovals": true
      },
      "outputVariable": "removedGroups"
    },
    {
      "id": "6",
      "name": "Unassign All Applications",
      "action": "okta.apps.unassignAll",
      "parameters": {
        "userId": "{{variables.userId}}",
        "logUnassignments": true
      },
      "outputVariable": "unassignedApps"
    },
    {
      "id": "7",
      "name": "Reset All MFA Factors",
      "action": "okta.factors.resetAll",
      "parameters": {
        "userId": "{{variables.userId}}",
        "factorTypes": ["push", "sms", "email", "webauthn", "token:software:totp"]
      }
    },
    {
      "id": "8",
      "name": "Deregister Devices",
      "action": "okta.devices.deregisterAll",
      "parameters": {
        "userId": "{{variables.userId}}"
      }
    },
    {
      "id": "9",
      "name": "Apply Compliance Hold",
      "action": "okta.groups.addMember",
      "parameters": {
        "groupId": "{{config.complianceHoldGroup}}",
        "userId": "{{variables.userId}}",
        "metadata": {
          "holdReason": "{{variables.terminationType}}",
          "holdStartDate": "{{now()}}",
          "holdEndDate": "{{addDays(now(), variables.retentionPeriod)}}"
        }
      },
      "conditions": {
        "variables.complianceHoldRequired": {
          "equals": true
        }
      }
    },
    {
      "id": "10",
      "name": "Schedule User Deletion",
      "action": "scheduler.createJob",
      "parameters": {
        "jobType": "USER_DELETION",
        "scheduledDate": "{{addDays(variables.terminationDate, variables.retentionPeriod)}}",
        "payload": {
          "userId": "{{variables.userId}}",
          "userEmail": "{{variables.userEmail}}"
        }
      },
      "conditions": {
        "config.autoDeleteEnabled": {
          "equals": true
        }
      }
    },
    {
      "id": "11",
      "name": "Deactivate User Account",
      "action": "okta.users.deactivate",
      "parameters": {
        "userId": "{{variables.userId}}",
        "sendEmail": false
      }
    },
    {
      "id": "12",
      "name": "Update User Profile with Offboarding Metadata",
      "action": "okta.users.updateProfile",
      "parameters": {
        "userId": "{{variables.userId}}",
        "profile": {
          "offboardingDate": "{{variables.terminationDate}}",
          "offboardingType": "{{variables.terminationType}}",
          "offboardingCompletedAt": "{{now()}}",
          "retentionEndDate": "{{addDays(now(), variables.retentionPeriod)}}"
        }
      }
    },
    {
      "id": "13",
      "name": "Trigger Downstream Deprovisioning",
      "action": "webhook.callMultiple",
      "parameters": {
        "webhooks": [
          {
            "name": "Active Directory",
            "url": "{{config.adDeprovisioningUrl}}",
            "method": "POST",
            "body": {
              "action": "disable",
              "userEmail": "{{variables.userEmail}}"
            }
          },
          {
            "name": "Google Workspace",
            "url": "{{config.googleDeprovisioningUrl}}",
            "method": "POST",
            "body": {
              "action": "suspend",
              "userEmail": "{{variables.userEmail}}"
            }
          },
          {
            "name": "Slack",
            "url": "{{config.slackDeprovisioningUrl}}",
            "method": "POST",
            "body": {
              "action": "deactivate",
              "userEmail": "{{variables.userEmail}}"
            }
          }
        ]
      }
    },
    {
      "id": "14",
      "name": "Create Offboarding Report",
      "action": "report.generate",
      "parameters": {
        "template": "offboarding_summary",
        "format": "pdf",
        "data": {
          "user": {
            "id": "{{variables.userId}}",
            "email": "{{variables.userEmail}}",
            "name": "{{variables.userName}}",
            "department": "{{variables.department}}"
          },
          "offboarding": {
            "date": "{{variables.terminationDate}}",
            "type": "{{variables.terminationType}}",
            "completedAt": "{{now()}}"
          },
          "accessRemoved": {
            "groups": "{{removedGroups}}",
            "applications": "{{unassignedApps}}"
          },
          "compliance": {
            "holdApplied": "{{variables.complianceHoldRequired}}",
            "retentionEndDate": "{{addDays(now(), variables.retentionPeriod)}}"
          }
        },
        "storageLocation": "{{config.auditStoragePath}}/{{variables.userId}}/offboarding_report.pdf"
      },
      "outputVariable": "offboardingReport"
    },
    {
      "id": "15",
      "name": "Notify Manager",
      "action": "email.send",
      "parameters": {
        "to": "{{variables.managerEmail}}",
        "subject": "Offboarding Complete: {{variables.userName}}",
        "template": "offboarding_manager_notification",
        "attachments": ["{{offboardingReport.path}}"],
        "variables": {
          "employeeName": "{{variables.userName}}",
          "offboardingDate": "{{variables.terminationDate}}",
          "accessRemovedCount": "{{add(removedGroups.count, unassignedApps.count)}}"
        }
      }
    },
    {
      "id": "16",
      "name": "Notify HR Team",
      "action": "email.send",
      "parameters": {
        "to": "{{config.hrTeamEmail}}",
        "subject": "Offboarding Complete: {{variables.userName}} ({{variables.department}})",
        "template": "offboarding_hr_notification",
        "attachments": ["{{offboardingReport.path}}"],
        "variables": {
          "employeeName": "{{variables.userName}}",
          "employeeEmail": "{{variables.userEmail}}",
          "department": "{{variables.department}}",
          "manager": "{{variables.managerEmail}}",
          "terminationType": "{{variables.terminationType}}",
          "complianceHold": "{{variables.complianceHoldRequired}}",
          "retentionEndDate": "{{addDays(now(), variables.retentionPeriod)}}"
        }
      }
    },
    {
      "id": "17",
      "name": "Notify Security Team",
      "action": "email.send",
      "parameters": {
        "to": "{{config.securityTeamEmail}}",
        "subject": "[Security] User Offboarded: {{variables.userEmail}}",
        "template": "offboarding_security_notification",
        "priority": "high",
        "variables": {
          "userName": "{{variables.userName}}",
          "userEmail": "{{variables.userEmail}}",
          "accessSnapshot": "{{preOffboardingSnapshot.summary}}",
          "terminationType": "{{variables.terminationType}}"
        }
      },
      "conditions": {
        "variables.terminationType": {
          "in": ["involuntary", "security_concern", "immediate"]
        }
      }
    },
    {
      "id": "18",
      "name": "Send SIEM Event",
      "action": "webhook.call",
      "parameters": {
        "url": "{{config.siemWebhookUrl}}",
        "method": "POST",
        "headers": {
          "Authorization": "Bearer {{secrets.siemApiKey}}",
          "Content-Type": "application/json"
        },
        "body": {
          "eventType": "IAM_USER_OFFBOARDED",
          "timestamp": "{{now()}}",
          "severity": "INFO",
          "user": {
            "id": "{{variables.userId}}",
            "email": "{{variables.userEmail}}",
            "department": "{{variables.department}}"
          },
          "offboarding": {
            "type": "{{variables.terminationType}}",
            "date": "{{variables.terminationDate}}"
          },
          "accessChanges": {
            "groupsRemoved": "{{removedGroups.count}}",
            "appsRemoved": "{{unassignedApps.count}}",
            "factorsReset": true,
            "sessionsRevoked": true
          },
          "compliance": {
            "holdApplied": "{{variables.complianceHoldRequired}}",
            "retentionDays": "{{variables.retentionPeriod}}"
          }
        }
      }
    },
    {
      "id": "19",
      "name": "Log Offboarding Complete",
      "action": "audit.log",
      "parameters": {
        "eventType": "OFFBOARDING_COMPLETED",
        "userId": "{{variables.userId}}",
        "severity": "INFO",
        "details": {
          "duration": "{{calculateDuration(event.timestamp)}}",
          "groupsRemoved": "{{removedGroups.count}}",
          "appsRemoved": "{{unassignedApps.count}}",
          "complianceHold": "{{variables.complianceHoldRequired}}",
          "reportPath": "{{offboardingReport.path}}"
        }
      }
    }
  ],
  "errorHandling": {
    "onFailure": "halt_and_escalate",
    "notifyEmails": ["iam-team@example.com", "security-team@example.com"],
    "retryAttempts": 2,
    "retryDelay": 30,
    "escalation": {
      "afterRetries": "create_p1_incident",
      "priority": "critical",
      "reason": "Offboarding failure presents security risk"
    },
    "rollbackNotAllowed": true,
    "manualInterventionRequired": true
  },
  "compliance": {
    "auditTrail": true,
    "retentionDays": 2555,
    "frameworks": ["SOC2", "ISO27001", "NIST", "GDPR"],
    "controlMappings": {
      "SOC2": ["CC6.1", "CC6.2", "CC6.3", "CC6.7"],
      "ISO27001": ["A.9.2.1", "A.9.2.6", "A.7.3.1"],
      "NIST": ["AC-2", "PS-4", "PS-5"],
      "GDPR": ["Article 17", "Article 25"]
    },
    "evidenceGeneration": {
      "enabled": true,
      "outputFormat": "pdf",
      "includeTimestamps": true,
      "includeApprovals": true
    }
  },
  "sla": {
    "maxDuration": 300,
    "warningThreshold": 180,
    "escalateOnBreach": true
  },
  "metadata": {
    "author": "Mike Dominic",
    "createdAt": "2025-12-05",
    "updatedAt": "2025-12-05",
    "chainguardRelevance": "Demonstrates comprehensive offboarding with compliance hold, audit trail, and regulatory framework alignment - addresses SOC 2, ISO 27001, NIST, GDPR requirements for IT Engineer (Identity/IAM) role"
  }
}
