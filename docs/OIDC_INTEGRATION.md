# OIDC/OAuth 2.0 Integration Guide

This guide explains how to configure an OpenID Connect (OIDC) application in Okta and integrate it with the React SPA.

## Table of Contents

1. [OIDC Overview](#oidc-overview)
2. [Create OIDC App in Okta](#create-oidc-app-in-okta)
3. [Configure React Application](#configure-react-application)
4. [Test Authentication Flow](#test-authentication-flow)
5. [Token Management](#token-management)
6. [Protected API Integration](#protected-api-integration)
7. [Troubleshooting](#troubleshooting)

## OIDC Overview

### What is OIDC?

**OpenID Connect (OIDC)** is an identity layer built on top of OAuth 2.0. It provides:
- **Authentication:** Who the user is (ID Token)
- **Authorization:** What the user can access (Access Token)
- **User Info:** Profile data via UserInfo endpoint

### OAuth 2.0 Flow (Authorization Code + PKCE)

```
React SPA → Okta Authorization → User Login → Okta → Token → React
    1            2                   3         4      5      6

1. User clicks "Login"
2. Redirect to Okta with PKCE challenge
3. User authenticates (username + password + MFA)
4. Okta redirects back with authorization code
5. Exchange code for tokens (using PKCE verifier)
6. Store tokens and access protected resources
```

### Key Components

- **Authorization Code:** One-time code exchanged for tokens
- **PKCE:** Proof Key for Code Exchange (secures SPAs without client secret)
- **ID Token:** JWT containing user identity (for authentication)
- **Access Token:** JWT for API authorization (scoped access)
- **Refresh Token:** Long-lived token to obtain new access tokens

### PKCE (Proof Key for Code Exchange)

PKCE eliminates the need for client secrets in SPAs:

1. **Code Verifier:** Random string generated by SPA
2. **Code Challenge:** SHA256 hash of verifier
3. **Challenge sent** to authorization endpoint
4. **Verifier sent** to token endpoint
5. **Okta validates** challenge matches verifier

## Create OIDC App in Okta

### Step 1: Navigate to Applications

1. Log in to Okta Admin Console: `https://dev-12345678-admin.okta.com`
2. Go to **Applications → Applications**
3. Click **Create App Integration**

### Step 2: Select OIDC

1. Choose **OIDC - OpenID Connect**
2. Choose **Single-Page Application**
3. Click **Next**

### Step 3: Configure Application Settings

#### General Settings

- **App integration name:** React OIDC SPA
- **Logo:** (Optional) Upload React logo

#### Grant type

Select:
- ✅ **Authorization Code** (with PKCE)
- ✅ **Refresh Token** (for token refresh)

#### Sign-in redirect URIs

Add:
- `http://localhost:3000/login/callback`
- `http://localhost:3000/implicit/callback` (for compatibility)

#### Sign-out redirect URIs

Add:
- `http://localhost:3000`

#### Controlled access

Select:
- **Allow everyone in your organization to access**
- Or **Limit access to selected groups** (choose specific groups)

Click **Save**

### Step 4: Note Application Credentials

After creation, you'll see:

- **Client ID:** `0oa...` (copy this)
- **Client authentication:** None (PKCE doesn't need secret)

Example:
```
CLIENT_ID=0oa1b2c3d4e5f6g7h8i9
```

### Step 5: Configure Trusted Origins

CORS must be configured for localhost:

1. Go to **Security → API → Trusted Origins**
2. Click **Add Origin**
3. Configure:
   - **Name:** React SPA Localhost
   - **Origin URL:** `http://localhost:3000`
   - **Type:**
     - ✅ CORS
     - ✅ Redirect
4. Click **Save**

### Step 6: Assign Users

1. Go to **Applications → React OIDC SPA**
2. Click **Assignments** tab
3. Click **Assign → Assign to People**
4. Select test users
5. Click **Assign** then **Done**

## Configure React Application

### Step 1: Install Dependencies

```bash
cd apps/react-oidc-spa
npm install
```

This installs:
- `react`, `react-dom` - React framework
- `react-router-dom` - Routing
- `@okta/okta-react` - Okta React SDK
- `@okta/okta-auth-js` - Okta Auth SDK
- `typescript` - TypeScript support

### Step 2: Configure Environment Variables

Create `apps/react-oidc-spa/.env`:

```bash
REACT_APP_OKTA_DOMAIN=dev-12345678.okta.com
REACT_APP_OKTA_CLIENT_ID=0oa1b2c3d4e5f6g7h8i9
REACT_APP_OKTA_ISSUER=https://dev-12345678.okta.com/oauth2/default
REACT_APP_REDIRECT_URI=http://localhost:3000/login/callback
REACT_APP_SCOPES=openid profile email
```

**Important:**
- Replace `dev-12345678` with your Okta domain
- Replace `0oa1b2c3d4e5f6g7h8i9` with your Client ID
- Issuer URL uses `/oauth2/default` authorization server

### Step 3: Run Application

```bash
npm start
```

Application runs on: `http://localhost:3000`

## Test Authentication Flow

### Step 1: Access Application

1. Open browser: `http://localhost:3000`
2. You'll see the landing page with **Login** button

### Step 2: Initiate Login

1. Click **Login**
2. Browser redirects to Okta:
   ```
   https://dev-12345678.okta.com/oauth2/default/v1/authorize?
     client_id=0oa...&
     redirect_uri=http://localhost:3000/login/callback&
     response_type=code&
     scope=openid profile email&
     state=...&
     code_challenge=...&
     code_challenge_method=S256
   ```

### Step 3: Authenticate

1. Enter credentials:
   - Username: `john.developer@example.com`
   - Password: (your password)
2. Complete MFA (if required)
3. Click **Sign In**

### Step 4: Authorization Code Exchange

1. Okta redirects back with code:
   ```
   http://localhost:3000/login/callback?code=ABC123&state=...
   ```

2. Okta React SDK automatically:
   - Extracts authorization code
   - Sends code + PKCE verifier to token endpoint
   - Receives ID Token, Access Token, Refresh Token
   - Stores tokens in memory/sessionStorage

3. User redirected to `/dashboard`

### Step 5: Authenticated State

Dashboard displays:
- User's name: "Welcome, John Developer!"
- Email: john.developer@example.com
- **Logout** button

### Verify Tokens

Open browser DevTools → Application → Session Storage → `http://localhost:3000`

You'll see:
```
okta-token-storage: {
  "idToken": {
    "value": "eyJraWQiOiJ...",
    "claims": {
      "sub": "00u...",
      "name": "John Developer",
      "email": "john.developer@example.com",
      ...
    }
  },
  "accessToken": {
    "value": "eyJraWQiOiJ...",
    "scopes": ["openid", "profile", "email"]
  }
}
```

## Token Management

### ID Token (Authentication)

**Purpose:** Proves user identity
**Format:** JWT (JSON Web Token)
**Lifetime:** 1 hour (default)

**Claims:**
```json
{
  "sub": "00u1a2b3c4d5e6f7g8h",
  "name": "John Developer",
  "email": "john.developer@example.com",
  "preferred_username": "john.developer@example.com",
  "iss": "https://dev-12345678.okta.com/oauth2/default",
  "aud": "0oa1b2c3d4e5f6g7h8i9",
  "iat": 1638360000,
  "exp": 1638363600
}
```

### Access Token (Authorization)

**Purpose:** Access protected APIs
**Format:** JWT
**Lifetime:** 1 hour (default)

**Claims:**
```json
{
  "sub": "00u1a2b3c4d5e6f7g8h",
  "scp": ["openid", "profile", "email"],
  "iss": "https://dev-12345678.okta.com/oauth2/default",
  "aud": "api://default",
  "iat": 1638360000,
  "exp": 1638363600
}
```

### Refresh Token

**Purpose:** Obtain new access tokens without re-authentication
**Format:** Opaque string (not JWT)
**Lifetime:** Configurable (default: 90 days for SPAs)

### Automatic Token Refresh

Okta React SDK handles token refresh automatically:

```typescript
// In OktaAuth.tsx
const oktaAuth = new OktaAuth({
  issuer: config.issuer,
  clientId: config.clientId,
  redirectUri: config.redirectUri,
  scopes: config.scopes,
  tokenManager: {
    autoRenew: true,  // Automatically refresh tokens
    expireEarlySeconds: 300  // Renew 5 minutes before expiry
  }
});
```

### Manual Token Refresh

If needed, manually refresh:

```typescript
import { useOktaAuth } from '@okta/okta-react';

function Component() {
  const { oktaAuth } = useOktaAuth();

  const refreshTokens = async () => {
    try {
      const tokens = await oktaAuth.tokenManager.renew('accessToken');
      console.log('New access token:', tokens);
    } catch (error) {
      console.error('Token refresh failed:', error);
      // Redirect to login
      oktaAuth.signInWithRedirect();
    }
  };

  // ...
}
```

## Protected API Integration

### Step 1: Send Access Token to API

```typescript
import { useOktaAuth } from '@okta/okta-react';

function Dashboard() {
  const { oktaAuth, authState } = useOktaAuth();
  const [data, setData] = useState(null);

  useEffect(() => {
    const fetchProtectedData = async () => {
      const accessToken = authState?.accessToken?.accessToken;

      const response = await fetch('http://localhost:8080/api/protected', {
        headers: {
          'Authorization': `Bearer ${accessToken}`
        }
      });

      const data = await response.json();
      setData(data);
    };

    if (authState?.isAuthenticated) {
      fetchProtectedData();
    }
  }, [authState]);

  return (
    <div>
      <h1>Protected Data</h1>
      <pre>{JSON.stringify(data, null, 2)}</pre>
    </div>
  );
}
```

### Step 2: API Validates Token

Node.js API (see `apps/node-api/` for full implementation):

```javascript
const OktaJwtVerifier = require('@okta/jwt-verifier');

const oktaJwtVerifier = new OktaJwtVerifier({
  issuer: 'https://dev-12345678.okta.com/oauth2/default',
  clientId: '0oa1b2c3d4e5f6g7h8i9'
});

app.get('/api/protected', async (req, res) => {
  try {
    const authHeader = req.headers.authorization;
    const token = authHeader.split(' ')[1];

    // Verify JWT signature and claims
    const jwt = await oktaJwtVerifier.verifyAccessToken(token, 'api://default');

    // Token valid - return protected data
    res.json({
      message: 'Access granted',
      user: jwt.claims.sub
    });
  } catch (error) {
    res.status(401).json({ error: 'Unauthorized' });
  }
});
```

## Scopes and Claims

### Requesting Scopes

Scopes define what data the app can access:

```typescript
const config = {
  scopes: ['openid', 'profile', 'email', 'groups']
};
```

**Standard Scopes:**
- `openid` - Required for OIDC
- `profile` - Name, locale, timezone
- `email` - Email address
- `phone` - Phone number
- `address` - Physical address
- `groups` - User's group memberships

### Custom Scopes

For API access control:

1. In Okta, go to **Security → API → Authorization Servers**
2. Select **default**
3. Go to **Scopes** tab
4. Click **Add Scope**
5. Configure:
   - **Name:** `read:data`
   - **Description:** Read access to data
6. Save

Request in React:
```typescript
scopes: ['openid', 'profile', 'email', 'read:data']
```

Validate in API:
```javascript
if (jwt.claims.scp.includes('read:data')) {
  // Allow access
}
```

## Logout

### Step 1: Implement Logout

```typescript
import { useOktaAuth } from '@okta/okta-react';

function Header() {
  const { oktaAuth, authState } = useOktaAuth();

  const logout = async () => {
    await oktaAuth.signOut({
      postLogoutRedirectUri: 'http://localhost:3000'
    });
  };

  if (!authState?.isAuthenticated) {
    return null;
  }

  return (
    <header>
      <button onClick={logout}>Logout</button>
    </header>
  );
}
```

### Step 2: Logout Flow

1. User clicks **Logout**
2. `oktaAuth.signOut()` called
3. Tokens cleared from storage
4. Browser redirects to Okta logout endpoint
5. Okta session ended
6. Redirect back to `postLogoutRedirectUri`

## Troubleshooting

### Redirect URI Mismatch

**Problem:** `redirect_uri_mismatch` error
**Solution:**
- Verify redirect URI in Okta app matches exactly
- Check for trailing slashes
- Ensure HTTPS in production
- Update `.env` file with correct URI

### CORS Errors

**Problem:** `CORS policy: No 'Access-Control-Allow-Origin' header`
**Solution:**
- Add Trusted Origin in Okta for `http://localhost:3000`
- Ensure both CORS and Redirect are checked
- Clear browser cache

### Token Expired

**Problem:** `JWT is expired`
**Solution:**
- Enable auto-renewal in tokenManager
- Check system clock is synchronized
- Verify token lifetime in Okta authorization server

### Login Loop

**Problem:** Infinite redirect loop
**Solution:**
- Check callback route is configured: `/login/callback`
- Verify SecureRoute is used for protected pages
- Clear browser cookies and storage

### No Access Token

**Problem:** Access token not received
**Solution:**
- Verify grant type includes Authorization Code
- Check scopes requested are valid
- Ensure Refresh Token grant type enabled
- Review Okta system logs for errors

## Security Best Practices

### Token Storage

- ✅ **Use memory storage** for highest security (lost on refresh)
- ✅ **Use sessionStorage** for convenience (lost on tab close)
- ❌ **Avoid localStorage** (persists across sessions, XSS risk)

```typescript
const oktaAuth = new OktaAuth({
  // ...
  tokenManager: {
    storage: 'sessionStorage'  // or 'memory'
  }
});
```

### State Parameter

PKCE includes state parameter for CSRF protection - handled automatically by SDK.

### HTTPS in Production

Always use HTTPS for production:
- Redirect URIs: `https://yourdomain.com/login/callback`
- Trusted Origins: `https://yourdomain.com`

### Content Security Policy

Add CSP headers:
```html
<meta http-equiv="Content-Security-Policy"
  content="default-src 'self'; connect-src 'self' https://*.okta.com; img-src 'self' data:;">
```

## Production Deployment

### Environment Variables

Create `.env.production`:

```bash
REACT_APP_OKTA_DOMAIN=yourdomain.okta.com
REACT_APP_OKTA_CLIENT_ID=0oa...
REACT_APP_OKTA_ISSUER=https://yourdomain.okta.com/oauth2/default
REACT_APP_REDIRECT_URI=https://yourdomain.com/login/callback
REACT_APP_SCOPES=openid profile email
```

### Update Okta App

1. Add production redirect URIs
2. Add production trusted origins
3. Update sign-out URIs

### Build for Production

```bash
npm run build
```

Outputs to `build/` directory - deploy to web server.

## Next Steps

- [Configure Node.js API](../apps/node-api/README.md)
- [Set up SCIM Provisioning](SCIM_PROVISIONING.md)
- [Configure MFA Policies](MFA_POLICIES.md)

## References

- [OAuth 2.0 Specification](https://oauth.net/2/)
- [OpenID Connect Specification](https://openid.net/connect/)
- [PKCE RFC 7636](https://datatracker.ietf.org/doc/html/rfc7636)
- [Okta OIDC Documentation](https://developer.okta.com/docs/guides/sign-into-spa/react/main/)
- [@okta/okta-react SDK](https://github.com/okta/okta-react)

---

**OIDC Integration Complete!** Your React SPA now supports modern authentication.
